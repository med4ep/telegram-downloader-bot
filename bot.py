import os
import asyncio
import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import yt_dlp

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
BOT_TOKEN = os.environ.get("BOT_TOKEN")

if not BOT_TOKEN:
    raise ValueError("âŒ BOT_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©!")

# Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
DOWNLOAD_FOLDER = "/tmp/downloads"
os.makedirs(DOWNLOAD_FOLDER, exist_ok=True)

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
SUPPORTED_SITES = """
ğŸŒ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©:
â€¢ YouTube
â€¢ Facebook
â€¢ Instagram
â€¢ Twitter/X
â€¢ TikTok
â€¢ Reddit
â€¢ Vimeo
â€¢ Dailymotion
â€¢ SoundCloud
ÙˆØ£ÙƒØ«Ø± Ù…Ù† 1000+ Ù…ÙˆÙ‚Ø¹ Ø¢Ø®Ø±!
"""

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨"""
    welcome_msg = f"""
Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„! ğŸ‘‹

Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø±Ø§Ø¨Ø· Ù…Ù† Ø£ÙŠ Ù…ÙˆÙ‚Ø¹ ØªÙˆØ§ØµÙ„ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨ØªØ­Ù…ÙŠÙ„Ù‡ Ù„Ùƒ.

{SUPPORTED_SITES}

Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:
/start - Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/info - Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª
"""
    await update.message.reply_text(welcome_msg)

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"""
    help_text = """
ğŸ“– ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:

1ï¸âƒ£ Ø§Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ/Ø§Ù„ØµÙˆØ±Ø©/Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù…Ù† Ø£ÙŠ Ù…ÙˆÙ‚Ø¹
2ï¸âƒ£ Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª
3ï¸âƒ£ Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„
4ï¸âƒ£ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„ÙŠÙƒ Ù…Ø¨Ø§Ø´Ø±Ø©!

âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:
â€¢ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª
â€¢ Ø¨Ø¹Ø¶ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ù‚Ø¯ ØªØ­ØªØ§Ø¬ ÙˆÙ‚ØªØ§Ù‹ Ø£Ø·ÙˆÙ„ Ù„Ù„ØªØ­Ù…ÙŠÙ„
â€¢ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„Ù‡Ø§
"""
    await update.message.reply_text(help_text)

async def info_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨ÙˆØª"""
    info_text = """
â„¹ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØª:

ğŸ¤– Ø¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„
ğŸ“¦ ÙŠØ¯Ø¹Ù… Ø£ÙƒØ«Ø± Ù…Ù† 1000+ Ù…ÙˆÙ‚Ø¹
âš¡ Ø³Ø±ÙŠØ¹ ÙˆØ³Ù‡Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
ğŸ”’ Ø¢Ù…Ù† ÙˆÙ…ÙˆØ«ÙˆÙ‚
â˜ï¸ ÙŠØ¹Ù…Ù„ Ø¹Ù„Ù‰ Koyeb

ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…:
â€¢ Python
â€¢ python-telegram-bot
â€¢ yt-dlp
"""
    await update.message.reply_text(info_text)

async def download_media(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·"""
    url = update.message.text.strip()
    
    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø³Ø§Ù„Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø·
    if not url.startswith(('http://', 'https://')):
        await update.message.reply_text("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø·Ø§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ http:// Ø£Ùˆ https://")
        return
    
    # Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
    status_msg = await update.message.reply_text("â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±")
    
    filename = None
    try:
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª yt-dlp
        ydl_opts = {
            'format': 'best[filesize<50M]/best',
            'outtmpl': f'{DOWNLOAD_FOLDER}/%(id)s.%(ext)s',
            'quiet': True,
            'no_warnings': True,
            'extract_flat': False,
            'nocheckcertificate': True,
            'geo_bypass': True,
        }
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ/Ø§Ù„Ù…Ù„Ù
        with yt_dlp.YoutubeDL(ydl_opts) as ydl:
            logger.info(f"Downloading from: {url}")
            info = ydl.extract_info(url, download=True)
            filename = ydl.prepare_filename(info)
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„Ù
            if not os.path.exists(filename):
                await status_msg.edit_text("âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¢Ø®Ø±.")
                return
            
            file_size = os.path.getsize(filename) / (1024 * 1024)
            logger.info(f"File size: {file_size:.2f} MB")
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
            if file_size > 50:
                await status_msg.edit_text("âŒ Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹ (Ø£ÙƒØ«Ø± Ù…Ù† 50 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª). Ø¬Ø±Ø¨ Ø±Ø§Ø¨Ø·Ø§Ù‹ Ø¢Ø®Ø±.")
                if os.path.exists(filename):
                    os.remove(filename)
                return
            
            await status_msg.edit_text("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...")
            
            # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù
            with open(filename, 'rb') as file:
                title = info.get('title', 'ØºÙŠØ± Ù…ØªÙˆÙØ±')
                if len(title) > 100:
                    title = title[:97] + "..."
                caption = f"âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!\n\nğŸ“ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: {title}"
                
                # ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
                ext = filename.split('.')[-1].lower()
                
                try:
                    if ext in ['mp4', 'mkv', 'avi', 'mov', 'webm']:
                        await update.message.reply_video(
                            video=file,
                            caption=caption,
                            supports_streaming=True,
                            read_timeout=60,
                            write_timeout=60
                        )
                    elif ext in ['mp3', 'm4a', 'wav', 'ogg']:
                        await update.message.reply_audio(
                            audio=file,
                            caption=caption,
                            read_timeout=60,
                            write_timeout=60
                        )
                    elif ext in ['jpg', 'jpeg', 'png', 'gif', 'webp']:
                        await update.message.reply_photo(
                            photo=file,
                            caption=caption,
                            read_timeout=60,
                            write_timeout=60
                        )
                    else:
                        await update.message.reply_document(
                            document=file,
                            caption=caption,
                            read_timeout=60,
                            write_timeout=60
                        )
                except Exception as send_error:
                    logger.error(f"Error sending file: {send_error}")
                    await status_msg.edit_text("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ±Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ØªØ§Ù„ÙØ§Ù‹.")
                    return
            
            # Ø­Ø°Ù Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
            await status_msg.delete()
            logger.info("File sent and deleted successfully")
            
    except yt_dlp.utils.DownloadError as e:
        error_msg = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„. ØªØ£ÙƒØ¯ Ù…Ù†:\nâ€¢ ØµØ­Ø© Ø§Ù„Ø±Ø§Ø¨Ø·\nâ€¢ Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„ÙŠØ³ Ø®Ø§ØµØ§Ù‹\nâ€¢ Ø£Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø¯Ø¹ÙˆÙ…"
        await status_msg.edit_text(error_msg)
        logger.error(f"Download error: {e}")
        
    except Exception as e:
        error_msg = f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰."
        await status_msg.edit_text(error_msg)
        logger.error(f"Unexpected error: {e}")
        
    finally:
        # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
        if filename and os.path.exists(filename):
            try:
                os.remove(filename)
                logger.info(f"Cleaned up: {filename}")
            except Exception as e:
                logger.error(f"Error cleaning up file: {e}")

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…"""
    logger.error(f"Exception while handling an update: {context.error}")

def main():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        application = Application.builder().token(BOT_TOKEN).build()
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±
        application.add_handler(CommandHandler("start", start))
        application.add_handler(CommandHandler("help", help_command))
        application.add_handler(CommandHandler("info", info_command))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, download_media))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        application.add_error_handler(error_handler)
        
        # Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
        logger.info("ğŸ¤– Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Koyeb...")
        application.run_polling(
            allowed_updates=Update.ALL_TYPES,
            drop_pending_updates=True
        )
        
    except Exception as e:
        logger.error(f"Failed to start bot: {e}")
        raise

if __name__ == '__main__':
    main()
